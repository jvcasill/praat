######################################################################
#### Robert Felty <robfelty - umich.edu>
#### 2005
#### This script comes with no warranty. Use at your own risk

## This script performs a filter on a highlighted section of a sound object.  
## The intended use is to make intervocalic consonants sound like coda 
## consonants.
## For fricatives, the filter created starts at the midpoint of the fricative,
## at the average intensity of the fricative, and scales it down to zero 
## intensity with a linear (dB) function.
## TODO:  tell user why script fails (e.g. if nothing is highlighted, or no 
## object is selected
 
######################################################################

##gets user input
form phoneme input
  comment Are you modifying a fricative or aspiration/burst/sonorant?
  choice phoneme rename_only
    button fricative
    button aspiration/burst/sonorant
    button rename_only
  comment please enter the new filename, and select the vowel
  word filename M1
  choice vowel a
    button a
    button i
    button u
endform
##comment If you selected aspiration/burst, please enter the avg vowel intensity
##real avg_vowel_intensity 0
###uses selected sound.  A portion must be highlighted
if phoneme <3
use_sound$ = selected$ ("Sound")

###get info about selection to use for filter
editor Sound 'use_sound$'
  avg_intensity = Get intensity
  begin = Get begin of selection
  end = Get end of selection
  new_end = end + 0.05
  duration = Get selection length
  filter_start_point = begin+(duration*0.5)
  filter_half_point = begin + 0.01
  asp_start_point = begin + (duration*0.3)
  pre_burst_point = begin - (duration*0.1)
endeditor
endif


###do this for fricatives
if phoneme = 1
####these lines print to the info window to make sure the script is working correctly; can delete later

half_intensity=0.5*avg_intensity
  Create IntensityTier... fric_decay begin end
  Edit
  editor IntensityTier fric_decay
  Add point at... pre_burst_point avg_intensity
    
  Add point at... filter_half_point half_intensity
    Add point at... end 0
  endeditor

  select Sound 'use_sound$'
  plus IntensityTier fric_decay
  Multiply
  Edit
new_sound$ = selected$("Sound")
 select IntensityTier fric_decay
  Remove
select Sound 'new_sound$'
Play
endif

###do this for aspiration/burst
if phoneme = 2
##create new intensity levels
  new_intensity = avg_intensity - 5
  intensity_10= avg_intensity*0.99
  intensity_20= avg_intensity*0.98
  intensity_30=avg_intensity*0.96
  intensity_40=avg_intensity*0.92
  intensity_50=avg_intensity*0.84
  intensity_60=avg_intensity*0.68
  intensity_70=avg_intensity*0.36
  intensity_80=avg_intensity*0.2
  intensity_90=avg_intensity*0.1
  intensity_100=0
##create time steps
  time10=begin + 0.1*duration
time20=begin + 0.2*duration
time30=begin + 0.3*duration
time40=begin + 0.4*duration
time50=begin + 0.5*duration
time60=begin + 0.6*duration
time70=begin + 0.7*duration
time80=begin + 0.8*duration
time90=begin + 0.9*duration
###time10=begin + 0.1*duration

#########
  
  Create IntensityTier... asp_decay begin end
  Edit
  editor IntensityTier asp_decay
#    Add point at... pre_burst_point avg_intensity
#   Add point at... asp_start_point new_intensity
#  Add point at... filter_start_point 40
  Add point at... begin avg_intensity 
  Add point at... time10 intensity_10
  Add point at... time20 intensity_20
  Add point at... time30 intensity_30
  Add point at... time40 intensity_40
  Add point at... time50 intensity_50
  Add point at... time60 intensity_60
  Add point at... time70 intensity_70
  Add point at... time80 intensity_80
  Add point at... time90 intensity_90

  

  Add point at... end 0
  endeditor
  select Sound 'use_sound$'
  plus IntensityTier asp_decay
  Multiply
  Edit
new_sound$ = selected$("Sound")
editor Sound 'new_sound$'
  Select... new_end 2
  Cut
endeditor
 select IntensityTier asp_decay
  Remove
select Sound 'new_sound$'
Play
endif

##Rename file and write to WAV


Rename... 'filename$'
if vowel = 1
write_dir$ = "ConfusionStimuli\ShannonModified\aCa\"
elsif vowel =2
write_dir$ = "ConfusionStimuli\ShannonModified\eeCee\"
elsif vowel=3
write_dir$ = "ConfusionStimuli\ShannonModified\uCu\"
endif
##write_file$ = 'write_dir$''filename$'



  Write to WAV file... L:\'write_dir$''filename$'.wav


###print info for debuggin

printline phoneme = 'phoneme' 'tab$' filename='filename$'
##printline Average Vowel Intensity = 'avg_vowel_intensity'
##printline filename='filename$'
printline  start 'tab$' end 'tab$'  duration 'tab$' filter start point 'tab$' average intensity
printline 'begin:4' 'tab$' 'end:4' 'tab$' 'duration:4' 'tab$' 'filter_start_point:4' 'tab$' 'avg_intensity:4'
##printline new end= 'new_end:4'
